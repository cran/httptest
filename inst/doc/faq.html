<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Frequently Asked Questions</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Frequently Asked Questions</h1>



<div id="where-are-my-mocks-recorded" class="section level2">
<h2>Where are my mocks recorded?</h2>
<p>By default, the destination path for <code>capture_requests()</code>
is relative to the current working directory of the process. This
matches the behavior of <code>with_mock_api()</code>, which looks for
files relative to its directory, which typically is
<code>tests/testthat/</code>.</p>
<p>If you’re running <code>capture_requests</code> within a test suite
in an installed package, or if you’re running interactively from a
different directory, the working directory may not be the same as your
code repository. If you aren’t sure where the files are going, set
<code>options(httptest.verbose=TRUE)</code>, and it will message the
absolute path of the files as it writes them.</p>
<p>To change where files are being written or read from, use
<code>.mockPaths()</code> (like <code>base::.libPaths()</code>) to
specify a different directory.</p>
</div>
<div id="how-do-i-fix-non-portable-file-paths" class="section level2">
<h2>How do I fix “non-portable file paths”?</h2>
<p>If you see this error in <code>R CMD build</code> or
<code>R CMD check</code>, it means that there are file paths are longer
than 100 characters, which can sometimes happen when you record
requests. <code>httptest</code> preserves the URL structure of mocks in
file paths to improve the readability and maintainability of your tests,
as well as to make visible the properties of your API. Indeed, the
file-system tree view of the mock files gives a visual representation of
your API. This value comes with a tradeoff: sometimes URLs can be long,
and R doesn’t like that.</p>
<p>Depending on how long your URLs are, there are a few ways to save on
characters without compromising readability of your code and tests.</p>
<p>A big way to cut long file paths is by using a request preprocessor:
a function that alters the content of your ‘httr’ <code>request</code>
before mapping it to a mock file. For example, if all of your API
endpoints sit beneath <code>https://language.googleapis.com/v1/</code>,
you could set a request preprocessor like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">set_requester</span>(<span class="cf">function</span> (request) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">gsub_request</span>(request, <span class="st">&quot;https</span><span class="sc">\\</span><span class="st">://language.googleapis.com/v1/&quot;</span>, <span class="st">&quot;api/&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>})</span></code></pre></div>
<p>and then all mocked requests would look for a path starting with
“api/” rather than “language.googleapis.com/v1/”, saving you (in this
case) 23 characters.</p>
<p>You can also provide this function in
<code>inst/httptest/request.R</code>, and any time your package is
loaded (as when you run tests or build vignettes), this function will be
called automatically. See <code>vignette(&quot;redacting&quot;)</code> for
more.</p>
<p>You may also be able to economize on other parts of the file paths.
If you’ve recorded requests and your file paths contain long ids like
“1495480537a3c1bf58486b7e544ce83d”, depending on how you access the API
in your code, you may be able to simply replace that id with something
shorter, like “1”. The mocks are just files, disconnected from a real
server and API, so you can rename them and munge them as needed.</p>
<p>Finally, if you have your tests inside a <code>tests/testthat/</code>
directory, and your fixture files inside that, you can save 9 characters
by moving the fixtures up to <code>tests/</code> and setting
<code>.mockPaths(&quot;../&quot;)</code>.</p>
</div>
<div id="how-do-i-switch-between-mocking-and-real-requests" class="section level2">
<h2>How do I switch between mocking and real requests?</h2>
<p><code>httptest</code> does not intend that every request in your test
suite is something that could be run against a live server. There are
practical reasons why you should be able to see, modify, and maintain
test fixtures, rather than re-record them every time you make a change.
Among the considerations:</p>
<ul>
<li>In many cases, API responses contain way more content than is
necessary to test your R code around them: 100 records when 2 will
suffice, request metadata that you don’t care about and can’t
meaningfully assert things about, and so on. In the interest of
minimally reproducible examples, and of making tests readable, it often
makes sense to take an actual API response and delete a lot of its
content, or even to fabricate one entirely.</li>
<li>It’s good to keep an API mock fixed so you know exactly what is in
it. If you re-recorded a Twitter API response of, say, the most recent
10 tweets with <code>#rstats</code>, the specific content will change
every time you record it, so your tests can’t say much about what is in
the response without having to rewrite them every time too.</li>
<li>Some conditions (rate limiting, server errors, e.g.) are difficult
to test with real responses, but if you can hand-create a API mock with,
say, a 503 response status code and test how your code handles it, you
can have confidence of how your package will respond when that rare
event happens with the real API.</li>
<li>Re-recording all responses can make for a huge code diff, which can
blow up your repository size and make code review harder.</li>
</ul>
<p>That said, it can be worthwhile to have a subset of tests that can be
run against a live API so that you can detect and respond to API
changes. One option is to set up some tests with the
<code>with_mock_dir()</code> context instead of
<code>with_mock_api()</code>. For example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">with_mock_dir</span>(<span class="st">&quot;httpbin-get&quot;</span>, {</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">&quot;https://httpbin.org/get&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="fu">print</span>(a)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>})</span></code></pre></div>
<p>The first time you run the code, it will create the directory
<code>tests/testthat/httpbin-get</code>, and create mock files under it.
The next times you run it, it will <em>use</em> the mock files in
<code>tests/testthat/httpbin-get</code>. To re-record, simply delete the
directory.</p>
<p>Another option is to have a secondary integration test suite in your
code repository, a directory outside of the standard R package
directories and included in <code>.Rbuildignore</code> so that it
doesn’t get packaged. You could run this locally with
<code>testthat::test_dir()</code>, and you could run it on continuous
integration builds by replacing the <code>tests/testthat</code>
directory with the alternate test directory.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
